# What'sOnTbilisi – AI Coding Guide

- **App Router stack**: Next.js 16 app router with TypeScript, Tailwind, Radix/shadcn UI, Redux Toolkit, TanStack Query, Supabase auth/DB, Cloudflare R2 storage, Google Maps. Root providers live in [app/layout.tsx](app/layout.tsx) (ErrorBoundary → progress bar → Redux store → React Query → Image cache → ThemeProvider → user init → MainLayout + Footer).
- **State**: Redux store in [lib/store/store.ts](lib/store/store.ts) registers `map`, `auth`, `follower`, `user` slices. Non-serializable Google Map instance is intentionally stored in `map` slice; middleware ignores action `map/setMap` and path `map.map` to silence warnings.
- **Auth/session flow**: Supabase browser client in [lib/supabase/supabaseClient.ts](lib/supabase/supabaseClient.ts); server helper in [lib/supabase/server.ts](lib/supabase/server.ts) with cookie wiring. `UserInitializer` in [components/auth/userInitializer.tsx](components/auth/userInitializer.tsx) dispatches `fetchUserSession`; user data fetched via thunks in [lib/store/userSlice.ts](lib/store/userSlice.ts) which call Supabase auth helpers in [lib/auth/auth.ts](lib/auth/auth.ts).
- **API route pattern**: Use wrappers from [lib/middleware/auth.ts](lib/middleware/auth.ts) (`withAuth`, `requireAuthorization`) and error helpers in [lib/utils/errorHandler.ts](lib/utils/errorHandler.ts). API errors return consistent JSON from `errorHandler.toApiResponse`. Avoid bypassing these utilities.
- **R2 storage**: AWS S3 client configured in [lib/r2/r2.ts](lib/r2/r2.ts) using env vars validated in [lib/utils/env.ts](lib/utils/env.ts). Upload/sign/delete routes live in [app/api/upload-image/route.ts](app/api/upload-image/route.ts), [app/api/get-image-signed-url/route.ts](app/api/get-image-signed-url/route.ts), [app/api/delete-image/route.ts](app/api/delete-image/route.ts); they enforce file type/size, path validation, and auth for destructive actions. Frontend uploads should use `handleUploadFile` from [lib/functions/helperFunctions.ts](lib/functions/helperFunctions.ts) which handles signing + PUT.
- **Query/cache**: React Query client configured in [lib/react-query/queryClient.ts](lib/react-query/queryClient.ts) (5 min stale, 30 min gc, single retry, no refetch on focus). Always wrap hooks inside [lib/react-query/QueryProvider.tsx](lib/react-query/QueryProvider.tsx).
- **UI shell**: MainLayout in [components/general/mainLayout.tsx](components/general/mainLayout.tsx) injects Toaster, auth dialogs, header, optional category/search rails depending on route, and wraps page content in [components/container/container.tsx](components/container/container.tsx). Progress bar styling set in [components/general/progressiveBarProvider.tsx](components/general/progressiveBarProvider.tsx).
- **Maps**: Map state (map instance, lat/lng, floating/fullscreen flags) in [lib/store/mapSlice.ts](lib/store/mapSlice.ts). Utility `zoomToLocation` in [lib/functions/helperFunctions.ts](lib/functions/helperFunctions.ts) expects a stored `google.maps.Map`.
- **Error handling/logging**: Global boundary in [components/ErrorBoundary.tsx](components/ErrorBoundary.tsx) logs via [lib/utils/logger.ts](lib/utils/logger.ts) (console in dev; ready for external sink). Prefer `logger` over `console` for consistency.
- **Env configuration**: Required vars (Supabase URL/anon key, R2 credentials/bucket) validated at load in [lib/utils/env.ts](lib/utils/env.ts). Missing vars throw in non-test; warn in dev. Optional: Google Maps key, NEXT_PUBLIC_R2_DEV_URL.
- **Images**: Next image config in [next.config.ts](next.config.ts) allows Cloudflare R2 hostnames, sets common qualities/device sizes, and long-lived cache headers for `/_next/image`.
- **Routing/pages**: Landing renders feed via [app/page.tsx](app/page.tsx) and [components/feed/Feed.tsx](components/feed/Feed.tsx). Feature routes under `app/activities`, `app/create-activity`, `app/discover`, `app/map`, `app/profile`, `app/users/[userId]`, etc.
- **API surface reference**: High-level routes documented in [docs/API.md](docs/API.md); follow those shapes when adding endpoints.
- **Testing**: Jest config in [jest.config.js](jest.config.js) uses next/jest, jsdom env, module alias `@/`. Collects coverage from app/lib/components with 50% thresholds. Playwright config in [playwright.config.ts](playwright.config.ts) runs against `npm run dev`, HTML reporter, retries on CI. Scripts: `npm test`, `npm run test:e2e`, `npm run test:e2e:ui`.
- **Linting/formatting**: ESLint extends Next core/web-vitals in [eslint.config.mjs](eslint.config.mjs); `any` and unused vars are warnings. Prettier with Tailwind plugin installed. Use path alias `@/*` from [tsconfig.json](tsconfig.json).
- **Performance/UX**: Dev server uses Turbopack via `npm run dev`. Progressive loading bar configured purple `#7c4dff`; ThemeProvider supports system theme; Toaster uses `sonner` rich colors.
- **Patterns to reuse**: For protected API logic, wrap handlers with `withAuth` and return JSON via `NextResponse`. For actions needing ownership checks, call `requireAuthorization` with target user id. For uploads, delegate to `handleUploadFile` and ensure file paths embed the user id to pass server-side checks.

If anything above is unclear or missing, tell me which sections need more detail (e.g., specific feature flows or data models) and I will refine this guide.
